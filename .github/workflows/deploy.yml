name: Build macOS

on:
    workflow_dispatch:

jobs:
    build:
        runs-on: macos-13
        permissions: write-all
        steps:
          - run: softwareupdate --list-full-installers
          - run: softwareupdate --download --fetch-full-installer --full-installer-version 14.3.1
          - run: hdiutil create -o /tmp/Sonoma -size 16000m -volname Sonoma -layout SPUD -fs HFS+J
          - run: hdiutil attach /tmp/Sonoma.dmg -noverify -mountpoint /Volumes/Sonoma
          - run: sudo /Applications/Install*.app/Contents/Resources/createinstallmedia --volume /Volumes/Sonoma --nointeraction
          - run: sudo hdiutil detach -force /Volumes/Install*
          - run: sudo hdiutil convert /tmp/Sonoma.dmg -format UDTO -o Sonoma.cdr
          - run: sudo mv Sonoma.cdr Sonoma.iso
          - run: zstd -11 Sonoma.iso -o Sonoma.iso.zst
          - name: split iso
            run: split -b 1.8G -d Sonoma.iso.zst Sonoma.iso.zst-
          - name: Create Release
            run: |
                gh release create ${GITHUB_REF##*/} -t "Releases ${GITHUB_REF##*/}"
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          - name: Upload Release Asset
            run: |
                gh release upload ${GITHUB_REF##*/} Sonoma.iso.zst-*
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
